#!/usr/bin/env ruby

require 'erb'
require 'fileutils'

RUBY_PREFIX = 'ruby/proto'
RUBY_VERSION_FILE = 'gitaly/version.rb'

def main
  write_ruby_requires
end

def write_ruby_requires
  requires = Dir.chdir(RUBY_PREFIX) { Dir['gitaly/*_services_pb.rb'] }.sort
  abort "No auto-generated Ruby service files found" if requires.empty?
  requires.unshift(RUBY_VERSION_FILE)
  gem_root = File.join(RUBY_PREFIX, 'gitaly.rb')
  gem_root_template = ERB.new <<~EOT
    # This file is generated by #{File.basename($0)}. Do not edit.
    $:.unshift(File.expand_path('../gitaly', __FILE__))
    <% requires.each do |f| %>
    require '<%= f.sub(/\.rb$/, '') %>'
    <% end %>
  EOT
  open(gem_root, 'w') { |f| f.write(gem_root_template.result(binding)) }
end

main
